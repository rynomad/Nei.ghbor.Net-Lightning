P=function(){var e=function(e,t){function n(e){return e?o(e):void 0}function o(e){for(var t in n.prototype)e[t]=n.prototype[t];return e}return e.exports=t,e.exports=n,n.prototype.on=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks[e]=this._callbacks[e]||[]).push(t),this},n.prototype.once=function(e,t){function n(){o.off(e,n),t.apply(this,arguments)}var o=this;return this._callbacks=this._callbacks||{},t._off=n,this.on(e,n),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n=this._callbacks[e];if(!n)return this;if(1==arguments.length)return delete this._callbacks[e],this;var o=n.indexOf(t._off||t);return~o&&n.splice(o,1),this},n.prototype.emit=function(e){this._callbacks=this._callbacks||{};var t=[].slice.call(arguments,1),n=this._callbacks[e];if(n){n=n.slice(0);for(var o=0,i=n.length;i>o;++o)n[o].apply(this,t)}return this},n.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks[e]||[]},n.prototype.hasListeners=function(e){return!!this.listeners(e).length},e.exports}({},{}),t=function(e,t){return e.exports=t,t.NAME="p",t.MESSAGE_TYPE={PLAIN:0,RTC_OFFER:3,RTC_ANSWER:4,RTC_ICE_CANDIDATE:5,RELAY:6,RELAYED:7},e.exports}({},{}),n=function(e,t){return e.exports=t,t.uuidV4=function(e,t){for(t=e="";36>e++;t+=52&51*e?(15^e?8^Math.random()*(20^e?16:4):4).toString(16):"-");return t},e.exports}({},{}),o=function(o,i){o.exports=i;var r,s=e,c=t,a=n.uuidV4,h=c.MESSAGE_TYPE;return r=o.exports=function(e){s.call(this),this.p=e,this.id=a(),this.relayedConnections={}},r.prototype=Object.create(s.prototype),r.prototype.getApi=function(){var e={};return e.on=this.on.bind(this),e.removeListener=this.removeListener.bind(this),e.to=this.to.bind(this),e.send=this.send.bind(this),e.relayed=this.relayed.bind(this),Object.defineProperty(e,"id",{value:this.id}),e},r.prototype.to=function(e){var t=this.createRtcConnection(this,e),n=t.getApi();return n.on("open",this.connectionHandler.bind(this,n)),t.createOffer(),n},r.prototype.send=function(e){e instanceof ArrayBuffer?this.sendToSocket(e):this.sendProtocolMessage(h.PLAIN,Array.prototype.slice.call(arguments))},r.prototype.relay=function(e,t){this.sendProtocolMessage(h.RELAY,e,t)},r.prototype.relayed=function(e,t){this.sendProtocolMessage(h.RELAYED,e,t)},r.prototype.sendProtocolMessage=function(){var e=Array.prototype.slice.call(arguments);e=JSON.stringify(e),this.sendToSocket(e)},r.prototype.messageHandler=function(e){if(e.data instanceof ArrayBuffer)this.emit("array buffer",e.data);else if("string"==typeof e.data){var t=JSON.parse(e.data);switch(t[0]){case h.RELAYED:this.relayedMessageHandler(t[1],t[2]);break;case h.PLAIN:this.emitPlainMessage(t[1]);break;case h.RELAY:this.relayMessageHandler(t[1],t[2])}}},r.prototype.emitPlainMessage=function(e){this.emit.apply(this,["message"].concat(e))},r.prototype.relayMessageHandler=function(e,t){var n=this.p.connectionMap[e];n&&n.relayed(this.id,t)},r.prototype.relayedMessageHandler=function(e,t){switch(t[0]){case h.RTC_OFFER:this.relayRtcOffer(e,t[1],t[2]);break;case h.RTC_ANSWER:this.relayRtcAnswer(e,t[1]);break;case h.RTC_ICE_CANDIDATE:this.relayRtcIceCandidate(e,t[1])}},r.prototype.connectionHandler=function(e){this.emit("connection",e)},r.prototype.relayFor=function(e,t){this.relayedConnections[t]=e},r.prototype.cancelRelay=function(e,t){var n=this.relayedConnections[t];n===e&&delete this.relayedConnections[t]},r.prototype.relayRtcOffer=function(e,t,n){var o=this;this.rtcFirewall(n,function(){var n=o.createRtcConnection(o,e),i=n.getApi();i.on("open",o.connectionHandler.bind(o,i)),n.createAnswer(t)})},r.prototype.relayRtcAnswer=function(e,t){var n=this.relayedConnections[e];n&&n.receiveAnswer(t)},r.prototype.relayRtcIceCandidate=function(e,t){var n=this.relayedConnections[e];n&&n.addIceCandidate(t)},r.prototype.rtcFirewall=function(e,t){t()},o.exports}({},{}),i=function(e,n){e.exports=n;var i,r=t,s=r.MESSAGE_TYPE,c=r.NAME,a=o,h=null,p={optional:[{RtpDataChannels:!0}]},l={optional:[],mandatory:{OfferToReceiveAudio:!1,OfferToReceiveVideo:!1}};return i=e.exports=function(e,t){this.connection=e,e.sendToSocket=this.sendToSocket.bind(this),e.createRtcConnection=i.create,this.rtcConnection=t,this.rtcConnection.onicecandidate=this.iceCandidateHandler.bind(this),this.rtcConnection.oniceconnectionstatechange=this.iceConnectionStateChangeHandler.bind(this),this.socket=t.createDataChannel(c,{reliable:!1}),this.socket.onmessage=this.connection.messageHandler.bind(this.connection),this.socket.onopen=this.openHandler.bind(this),this.socket.onclose=this.closeHandler.bind(this),this.socket.onerror=this.errorHandler.bind(this)},i.create=function(e,t,n){n=n||{};var o=n.configuration||h,r=n.constraints||p,s=n.rtcConnection||new webkitRTCPeerConnection(o,r),c=new a(e.p),l=new i(c,s);return l.setRelay(e,t),l},i.prototype.getApi=function(){var e=this.connection.getApi();return e.close=this.close.bind(this),e},i.prototype.close=function(){this.rtcConnection.close()},i.prototype.sendToSocket=function(e){switch(this.socket.readyState){case"connecting":throw Error("Can't send a message while RTCDataChannel connecting");case"open":this.socket.send(e);break;case"closing":case"closed":throw Error("Can't send a message while RTCDataChannel is closing or closed")}},i.prototype.iceConnectionStateChangeHandler=function(e){switch(e.currentTarget.iceConnectionState){case"new":break;case"checking":break;case"connected":break;case"completed":break;case"failed":break;case"disconnected":break;case"closed":}},i.prototype.errorHandler=function(e){this.connection.emit("error",e)},i.prototype.openHandler=function(){this.connection.emit("open")},i.prototype.closeHandler=function(){this.connection.emit("close")},i.prototype.setRelay=function(e,t){this.relay&&this.relay.relay(this,this.remoteId),this.relay=e,this.remoteId=t,this.relay.relayFor(this,t)},i.prototype.iceCandidateHandler=function(e){var t=e.candidate;t&&this.relay.relay(this.remoteId,[s.RTC_ICE_CANDIDATE,t])},i.prototype.createOffer=function(){var e=this;this.rtcConnection.createOffer(function(t){e.rtcConnection.setLocalDescription(t),e.relay.relay(e.remoteId,[s.RTC_OFFER,t])},null,l)},i.prototype.createAnswer=function(e){var t=this;this.rtcConnection.setRemoteDescription(new RTCSessionDescription(e)),this.rtcConnection.createAnswer(function(e){t.rtcConnection.setLocalDescription(e),t.relay.relay(t.remoteId,[s.RTC_ANSWER,e])})},i.prototype.receiveAnswer=function(e){this.rtcConnection.setRemoteDescription(new RTCSessionDescription(e))},i.prototype.addIceCandidate=function(e){this.rtcConnection.addIceCandidate(new RTCIceCandidate(e))},e.exports}({},{}),r=function(e,n){e.exports=n;var r,s=i,c=t,a=(c.MESSAGE_TYPE,c.NAME),h=o;return r=e.exports=function(e,t){this.connection=e,e.sendToSocket=this.sendToSocket.bind(this),e.createRtcConnection=s.create,this.socket=t,t.onopen=this.openHandler.bind(this),t.onclose=this.closeHandler.bind(this),t.onerror=this.errorHandler.bind(this),t.onmessage=this.connection.messageHandler.bind(this.connection)},r.create=function(e,t){var n=new WebSocket(t,a),o=new h(e),i=new r(o,n);return n.binaryType="arraybuffer",i},r.prototype.getApi=function(){var e=this.connection.getApi();return e.close=this.close.bind(this),e},s.prototype.close=function(){this.socket.close()},r.prototype.sendToSocket=function(e){switch(this.socket.readyState){case WebSocket.CONNECTING:throw Error("Can't send a message while WebSocket connecting");case WebSocket.OPEN:this.socket.send(e);break;case WebSocket.CLOSING:case WebSocket.CLOSED:throw Error("Can't send a message while WebSocket is closing or closed")}return this},r.prototype.close=function(){this.socket.close()},r.prototype.errorHandler=function(e){this.connection.emit("error",e)},r.prototype.closeHandler=function(){this.connection.emit("close")},r.prototype.openHandler=function(){this.connection.emit("open")},e.exports}({},{}),s=function(n,o){n.exports=o;var i,s=e,c=t,a=(c.MESSAGE_TYPE,c.NAME,r);return i=n.exports=function(e){this.emitter=e,this.connectionMap={},this.connectionList=[]},i.create=function(e){e=e||{};var t=e.emitter||new s,n=new i(t);return n.getApi()},i.prototype.getApi=function(){var e={};return e.on=this.on.bind(this),e.removeListener=this.removeListener.bind(this),e.to=this.to.bind(this),Object.defineProperty(e,"connections",{get:this.getConnections.bind(this)}),e},i.prototype.getConnections=function(){return this.connectionList.slice(0)},i.prototype.to=function(e){var t=a.create(this,e),n=t.getApi();return n.on("open",this.connectionHandler.bind(this,n)),n},i.prototype.on=function(){return this.emitter.on.apply(this.emitter,arguments),this},i.prototype.removeListener=function(){return this.emitter.removeListener.apply(this.emitter,arguments),this},i.prototype.connectionHandler=function(e){e.on("connection",this.connectionHandler.bind(this)),e.on("close",this.connectionCloseHandler.bind(this,e)),this.connectionMap[e.id]=e,this.connectionList.push(e),this.emitter.emit("connection",e)},i.prototype.connectionCloseHandler=function(e){var t=this.connectionList.indexOf(e);this.connectionList.splice(t,1),delete this.connectionMap[e.id]},n.exports}({},{});return function(e,t){return e.exports=t,window.P=s,e.exports}({},{}),s}();